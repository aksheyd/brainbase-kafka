# Backend WebSocket Communication Protocol (`/ws`)

This document outlines the JSON-based communication protocol used between the frontend client and the backend WebSocket server at the `/ws` endpoint. It handles CRU operations. 

## Overview

- All communication happens over a single WebSocket connection per user session.
- Messages in both directions are JSON objects.
- Each message MUST contain an `"action"` field indicating the message type.
- Responses from the server generally include a `"status"` field (`"success"` or `"error"`) and echo the original `"action"`. Error responses include an `"error"` field with a description.
- Session state (files, history) is maintained server-side per connection as the source of truth.

## Initial Connection

Upon successful connection, the server sends an initial state message:

**Server → Client:**
```json
{
  "status": "success",
  "action": "initial_state",
  "files": [], // Initially empty list of filenames
  "activeFile": null // Initially no active file
}
```

## Client Actions & Server Responses

### 1. Prompt (Generate Code or Diff)

Used to send a user prompt to the agent. The agent classifies the intent (create or edit) and responds accordingly.

**Client → Server:**
```json
{
  "action": "prompt",
  "prompt": "User's natural language request (e.g., 'create a simple counter agent', 'add error handling to the API call').",
  "context": [], // Optional: Array of context strings or objects relevant to the prompt
  "activeFile": "optional_filename.based" // Optional: The filename currently active/focused in the frontend editor
}
```

**Server → Client (Intent: CREATE_FILE):**
```json
{
  "status": "success",
  "action": "file_created", // Specific action indicating a new file was generated
  "filename": "generated-filename.based", // The filename generated by the agent
  "content": "...generated Based code...", // The initial code for the new file
  "files": ["generated-filename.based", ...] // Updated list of all files in the workspace
}
```

**Server → Client (Intent: EDIT_FILE):**
```json
{
  "status": "success",
  "action": "diff_generated", // Specific action indicating a diff was generated
  "filename": "existing-file.based", // The file the diff applies to
  "diff": "...unified diff string...", // The generated diff
  "new_code": "...code after applying diff...", // Preview of the code if the diff is applied
  "old_code": "...code before applying diff..." // Original code for reference/revert
}
```

**Server → Client (Error during Edit - No Active File):**
```json
{
  "status": "error",
  "action": "edit_error", // Specific error action
  "error": "Please select a file to edit. Active file '...' not found or invalid."
}
```

### 2. Apply Diff

Used to apply a previously generated diff to a file in the workspace.

**Client → Server:**
```json
{
  "action": "apply_diff",
  "filename": "existing-file.based", // The file to apply the diff to
  "diff": "...unified diff string..." // The diff to apply (usually from a 'diff_generated' response)
}
```

**Server → Client (Success):**
```json
{
  "status": "success",
  "action": "diff_applied", // Specific action indicating success
  "filename": "existing-file.based",
  "new_code": "...updated code after applying diff..." // The final code in the workspace
}
```

**Server → Client (Error):**
```json
{
  "status": "error",
  "action": "apply_diff_error", // Specific error action
  "error": "Patch failed: [details]" // Or "File not found..."
}
```

### 3. Upload File

Allows the client to directly create or overwrite a file in the workspace.

**Client → Server:**
```json
{
  "action": "upload_file",
  "filename": "myfile.based", // Desired filename
  "content": "...full file content..." // The complete content for the file
}
```

**Server → Client:**
```json
{
  "status": "success",
  "action": "file_uploaded", // Specific action name
  "filename": "myfile.based",
  "files": ["myfile.based", ...] // Updated list of all files
}
```

### 4. List Files

Requests the current list of filenames in the workspace.

**Client → Server:**
```json
{
  "action": "list_files"
}
```

**Server → Client:**
```json
{
  "status": "success",
  "action": "file_list", // Specific action name
  "files": ["agent.based", "myfile.based", ...] // List of filenames
}
```

### 5. Read File

Requests the content of a specific file from the workspace.

**Client → Server:**
```json
{
  "action": "read_file",
  "filename": "agent.based" // The filename to read
}
```

**Server → Client (Success):**
```json
{
  "status": "success",
  "action": "file_content", // Specific action name
  "filename": "agent.based",
  "content": "...full file content..."
}
```

**Server → Client (Error - File Not Found):**
```json
{
  "status": "error",
  "action": "read_file", // Action is echoed even on error
  "error": "File not found"
}
```

### 6. Operation Rejected (Server Busy)

Sent by the server if the client attempts an action (like `prompt` or `apply_diff`) while another long-running operation is already in progress for the same session.

**Server → Client:**
```json
{
  "status": "error",
  "action": "operation_rejected", // Specific action indicating rejection due to lock
  "error": "Another operation is already in progress. Please wait."
}
```

## General Error Response

If an unexpected error occurs or an action is invalid (e.g., unknown action, missing parameters), the server sends a generic error response.

**Server → Client:**
```json
{
  "status": "error",
  "error": "Description of the error (e.g., 'Unknown action: xyz', 'Invalid JSON', 'Internal server error').",
  // The original 'action' might be included if it was parseable
  "action": "original_action_if_known"
}
```

---

**Notes:**

- The frontend should typically wait for a response before sending the next action, especially for operations like `prompt` or `apply_diff`.
- The `diff_generated` response provides a preview (`new_code`). The frontend user should review this before sending an `apply_diff` request.
- The server uses locks to prevent race conditions during potentially long-running agent operations (`prompt`, `apply_diff`). If the lock is busy, the `operation_rejected` response is sent.